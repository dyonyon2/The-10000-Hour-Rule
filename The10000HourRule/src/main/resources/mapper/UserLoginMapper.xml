<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dyonyon.The10000HourRule.mapper.UserLoginMapper">
    <select id="getLoginResult" parameterType="com.dyonyon.The10000HourRule.domain.user.UserDetailInfo" resultType="com.dyonyon.The10000HourRule.domain.user.UserDetailInfo">
        SELECT * FROM USER_AUTH WHERE USER_ID = '${user_id}' AND PW = '${pw}'
    </select>
    <insert id="insertLoginLog" parameterType="com.dyonyon.The10000HourRule.domain.user.UserLoginInfo">
        INSERT INTO USER_LOGIN_LOG VALUES ('${req_id}', '${session_id}', '${user_id}', '0', SYSDATE, 'N')
    </insert>
    <select id="getLoginAttempt" parameterType="com.dyonyon.The10000HourRule.domain.user.UserLoginInfo" resultType="int">
        SELECT COUNT(*) FROM USER_LOGIN_LOG WHERE SESSION_ID = '${session_id}' AND USER_ID = '${user_id}' AND START_DT > SYSDATE - INTERVAL '30' MINUTE AND ATTEMPT_FLAG = 'N'
    </select>
    <update id="updateStatus" parameterType="com.dyonyon.The10000HourRule.domain.user.UserLoginInfo" >
        UPDATE USER_LOGIN_LOG SET STATUS = '${status}' WHERE REQ_ID = '${req_id}'
    </update>
    <update id="resetLoginAttempt" parameterType="com.dyonyon.The10000HourRule.domain.user.UserLoginInfo" >
        UPDATE USER_LOGIN_LOG SET ATTEMPT_FLAG = 'Y' WHERE USER_ID = '${user_id}' AND START_DT > SYSDATE - INTERVAL '30' MINUTE AND ATTEMPT_FLAG != 'Y'
    </update>
    <select id="getLoginSessionId" parameterType="java.lang.String" resultType="java.lang.String">
        SELECT SESSION_ID FROM USER_SESSION WHERE USER_ID = '${user_id}'
    </select>
    <update id="updateLoginSession" parameterType="com.dyonyon.The10000HourRule.domain.user.UserLoginInfo" >
        UPDATE USER_SESSION SET SESSION_ID = '${session_id}', UPDATE_DT = SYSDATE, EXPIRE_DT = SYSDATE + INTERVAL '30' MINUTE WHERE USER_IDX = '${user_idx}'
    </update>
    <insert id="insertLoginSession" parameterType="com.dyonyon.The10000HourRule.domain.user.UserLoginInfo">
        INSERT INTO USER_SESSION (USER_IDX, USER_ID, SESSION_ID) VALUES ('${user_idx}', '${user_id}','${session_id}')
    </insert>
    <select id="getLoginSessionEXP" parameterType="java.lang.String" resultType="java.util.Date">
        SELECT EXPIRE_DT FROM USER_SESSION WHERE USER_ID = '${user_id}'
    </select>
    <update id="updateSessionTime" parameterType="java.lang.String" >
        UPDATE USER_SESSION SET UPDATE_DT = SYSDATE, EXPIRE_DT = SYSDATE + INTERVAL '30' MINUTE WHERE USER_ID = '${user_id}'
    </update>
</mapper>